<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA Impact Analysis - Complete Breakdown | Quiet Light Brokerage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .brand-bg-navy { background-color: #0a1a3d; }
        .brand-bg-mint { background-color: #b8f7b8; }
        .brand-bg-blue { background-color: #297dde; }
        .brand-bg-teal { background-color: #66e0f5; }
        .brand-bg-green { background-color: #36a157; }
        .brand-text-navy { color: #0a1a3d; }
        .brand-text-green { color: #36a157; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .stat-card { transition: all 0.3s ease; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 900px; max-height: 80vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .clickable { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-underline-offset: 2px; }
        .clickable:hover { text-decoration-style: solid; }
        .highlight-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-left: 4px solid #36a157;
        }
        .warning-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
        .insight-box {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-left: 4px solid #6366f1;
        }
        .breakdown-card {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border: 1px solid #e5e7eb;
        }
        table.data-table { font-size: 0.875rem; }
        table.data-table th { background-color: #f9fafb; font-weight: 600; padding: 8px; text-align: left; }
        table.data-table td { padding: 6px 8px; border-bottom: 1px solid #e5e7eb; }
        table.data-table tr:hover { background-color: #f9fafb; }
        .tab-button { padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .tab-button.active { background-color: #297dde; color: white; }
        .tab-button:not(.active) { background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="brand-bg-navy text-white p-6 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">SBA Impact Analysis - Complete Breakdown</h1>
            <p class="text-gray-300 mt-2">Pre-Qualification vs Actual Usage | Time Impact Analysis</p>
            <p class="text-sm text-gray-400 mt-1">531 Valid Listings | Expanded Dataset with LOI Analysis</p>
        </div>
    </div>

    <!-- Critical Discovery Banner -->
    <div class="container mx-auto mt-6 px-4">
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg p-6 text-white">
            <h2 class="text-2xl font-bold mb-4">üîç Critical Discovery: The Real SBA Impact</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="text-3xl font-bold">50%</div>
                    <div class="text-sm">of SBA pre-qualified deals</div>
                    <div class="text-xs opacity-90">actually use SBA financing</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold">+21 days</div>
                    <div class="text-sm">TRUE SBA time penalty</div>
                    <div class="text-xs opacity-90">not 72 days as initially thought</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold">+18 days</div>
                    <div class="text-sm">Pre-qualification complexity</div>
                    <div class="text-xs opacity-90">even without SBA use</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="container mx-auto mt-8 px-4">
        <!-- Executive Summary -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold brand-text-navy mb-4">Executive Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
                    <div class="text-3xl font-bold brand-text-navy clickable" onclick="showModal('datasetBreakdown')">531</div>
                    <div class="text-sm text-gray-600">Valid Listings</div>
                    <div class="text-xs text-gray-500 mt-1">Click for breakdown</div>
                </div>
                <div class="stat-card bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
                    <div class="text-3xl font-bold brand-text-green clickable" onclick="showModal('successRates')">63.8%</div>
                    <div class="text-sm text-gray-600">Overall Success</div>
                    <div class="text-xs text-gray-500 mt-1">339 sold / 531 total</div>
                </div>
                <div class="stat-card bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg">
                    <div class="text-3xl font-bold" style="color: #6366f1;">19.2%</div>
                    <div class="text-sm text-gray-600">SBA Pre-Qualified</div>
                    <div class="text-xs text-gray-500 mt-1">102 of 531 listings</div>
                </div>
                <div class="stat-card bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg">
                    <div class="text-3xl font-bold" style="color: #f59e0b;">50%</div>
                    <div class="text-sm text-gray-600">Actually Use SBA</div>
                    <div class="text-xs text-gray-500 mt-1">When pre-qualified</div>
                </div>
            </div>
        </div>

        <!-- SBA Usage Breakdown -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold brand-text-navy mb-4">
                SBA Pre-Qualification vs Actual Usage 
                <span class="text-sm font-normal text-gray-500 ml-2 clickable" onclick="showModal('sbaUsageDetails')">[View Details]</span>
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Flow Chart -->
                <div>
                    <h3 class="font-semibold mb-3">SBA Decision Flow</h3>
                    <div class="space-y-3">
                        <div class="breakdown-card p-3 rounded">
                            <div class="font-semibold">531 Valid Listings</div>
                        </div>
                        <div class="ml-4 border-l-2 border-gray-300 pl-4">
                            <div class="breakdown-card p-3 rounded mb-2">
                                <div class="font-semibold text-green-600">102 SBA Pre-Qualified (19.2%)</div>
                                <div class="text-sm text-gray-600">76 sold, 26 lost</div>
                            </div>
                            <div class="ml-4 border-l-2 border-green-300 pl-4 space-y-2">
                                <div class="breakdown-card p-2 rounded">
                                    <div class="text-sm font-semibold">21 Used SBA (50%)</div>
                                    <div class="text-xs text-gray-600">Average: 187 days to close</div>
                                </div>
                                <div class="breakdown-card p-2 rounded">
                                    <div class="text-sm font-semibold">21 Used Other Financing (50%)</div>
                                    <div class="text-xs text-gray-600">Average: 184 days to close</div>
                                </div>
                            </div>
                        </div>
                        <div class="ml-4 border-l-2 border-gray-300 pl-4">
                            <div class="breakdown-card p-3 rounded">
                                <div class="font-semibold text-gray-600">429 Not Pre-Qualified (80.8%)</div>
                                <div class="text-sm text-gray-600">263 sold, 166 lost</div>
                                <div class="text-xs text-gray-600">Average: 166 days to close (sold only)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Time Impact Chart -->
                <div>
                    <h3 class="font-semibold mb-3">Days on Market Breakdown</h3>
                    <canvas id="timeBreakdownChart"></canvas>
                    <div class="mt-3 text-sm text-gray-600">
                        <p class="font-semibold">Key Insights:</p>
                        <ul class="list-disc list-inside text-xs space-y-1 mt-1">
                            <li>Actual SBA financing adds only +21 days (12.8%)</li>
                            <li>Pre-qualification complexity adds +18 days even without SBA</li>
                            <li>Original "72-day penalty" was misleading aggregate</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Rate Analysis -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold brand-text-navy mb-4">
                    Success Rates by Category
                    <span class="text-xs font-normal text-gray-500 ml-2 clickable" onclick="showModal('successDetails')">[Details]</span>
                </h3>
                <canvas id="successRateChart"></canvas>
                <div class="mt-4">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2">Category</th>
                                <th class="text-center py-2">Sold</th>
                                <th class="text-center py-2">Lost</th>
                                <th class="text-right py-2">Success %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-2">All SBA Pre-qualified</td>
                                <td class="text-center">76</td>
                                <td class="text-center">26</td>
                                <td class="text-right font-bold text-green-600">74.5%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-2 pl-4 text-gray-600">‚Üí Used SBA</td>
                                <td class="text-center">21</td>
                                <td class="text-center">0</td>
                                <td class="text-right font-bold">100%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-2 pl-4 text-gray-600">‚Üí No SBA</td>
                                <td class="text-center">21</td>
                                <td class="text-center">0</td>
                                <td class="text-right font-bold">100%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-2">Not Pre-qualified</td>
                                <td class="text-center">217</td>
                                <td class="text-center">150</td>
                                <td class="text-right font-bold">59.1%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold brand-text-navy mb-4">
                    LOI & Offer Analysis
                    <span class="text-xs font-normal text-gray-500 ml-2 clickable" onclick="showModal('loiDetails')">[Details]</span>
                </h3>
                <div class="space-y-4">
                    <div class="breakdown-card p-4 rounded">
                        <h4 class="font-semibold text-sm mb-2">Offer Statistics</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Total LOIs:</span>
                                <span class="font-bold ml-2" id="totalLOIs">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">SBA Offers:</span>
                                <span class="font-bold ml-2" id="sbaOffers">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">SBA Offer Rate:</span>
                                <span class="font-bold ml-2" id="sbaOfferRate">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">SBA Win Rate:</span>
                                <span class="font-bold ml-2" id="sbaWinRate">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="insight-box p-4 rounded">
                        <h4 class="font-semibold text-sm mb-2">Key Insights</h4>
                        <ul class="text-xs space-y-1">
                            <li>‚Ä¢ When SBA offers compete, they win 61% of the time</li>
                            <li>‚Ä¢ Only 16% of all offers involve SBA financing</li>
                            <li>‚Ä¢ 50% of pre-qualified deals choose non-SBA options</li>
                            <li>‚Ä¢ Pre-qualification provides optionality, not obligation</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Analysis Tabs -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-bold brand-text-navy mb-4">Detailed Time Analysis</h3>
            
            <!-- Tab Navigation -->
            <div class="flex space-x-2 mb-4 border-b">
                <button class="tab-button active" onclick="switchTab('overview')">Overview</button>
                <button class="tab-button" onclick="switchTab('distribution')">Distribution</button>
                <button class="tab-button" onclick="switchTab('percentiles')">Percentiles</button>
                <button class="tab-button" onclick="switchTab('methodology')">Methodology</button>
            </div>

            <!-- Tab Contents -->
            <div id="overview" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="breakdown-card p-4 rounded">
                        <h4 class="font-semibold text-sm mb-2">Actually Used SBA</h4>
                        <div class="text-2xl font-bold text-orange-600">187 days</div>
                        <div class="text-xs text-gray-600">Mean (Median: 151 days)</div>
                        <div class="text-xs mt-2">+21 days vs baseline</div>
                    </div>
                    <div class="breakdown-card p-4 rounded">
                        <h4 class="font-semibold text-sm mb-2">Pre-qualified, No SBA</h4>
                        <div class="text-2xl font-bold text-yellow-600">184 days</div>
                        <div class="text-xs text-gray-600">Mean (Median: 136 days)</div>
                        <div class="text-xs mt-2">+18 days vs baseline</div>
                    </div>
                    <div class="breakdown-card p-4 rounded">
                        <h4 class="font-semibold text-sm mb-2">Not Pre-qualified</h4>
                        <div class="text-2xl font-bold text-blue-600">166 days</div>
                        <div class="text-xs text-gray-600">Mean (Median: 116 days)</div>
                        <div class="text-xs mt-2">Baseline</div>
                    </div>
                </div>
                
                <div class="warning-box p-4 rounded mt-4">
                    <p class="text-sm"><strong>Important:</strong> The commonly cited "72-day SBA penalty" is actually composed of:</p>
                    <ul class="text-sm mt-2 list-disc list-inside">
                        <li>21 days - Actual SBA financing process</li>
                        <li>18 days - Business complexity (affects pre-qualified even without SBA)</li>
                        <li>33 days - Selection bias and other factors</li>
                    </ul>
                </div>
            </div>

            <div id="distribution" class="tab-content">
                <canvas id="distributionChart"></canvas>
                <p class="text-sm text-gray-600 mt-4">Distribution shows that SBA deals have a longer tail but similar median values.</p>
            </div>

            <div id="percentiles" class="tab-content">
                <table class="w-full data-table">
                    <thead>
                        <tr>
                            <th>Percentile</th>
                            <th>Used SBA</th>
                            <th>Pre-Q, No SBA</th>
                            <th>Not Pre-Q</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>25th</td><td>90 days</td><td>85 days</td><td>71 days</td></tr>
                        <tr><td>50th (Median)</td><td>151 days</td><td>136 days</td><td>116 days</td></tr>
                        <tr><td>75th</td><td>245 days</td><td>238 days</td><td>201 days</td></tr>
                        <tr><td>90th</td><td>342 days</td><td>330 days</td><td>298 days</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="methodology" class="tab-content">
                <h4 class="font-semibold mb-2">Data Sources & Methodology</h4>
                <ul class="text-sm space-y-2">
                    <li><strong>Dataset:</strong> 531 listings with definitive outcomes (sold/lost)</li>
                    <li><strong>SBA Usage:</strong> Determined from winning LOI data in closed_sale_reports</li>
                    <li><strong>Launch Date:</strong> Detected via inquiry volume patterns (20+ inquiries in 24-48 hours)</li>
                    <li><strong>Days on Market:</strong> Calculated from launch date to closed date</li>
                    <li><strong>Classification:</strong> Milestone IDs used for outcome determination (7=sold, 8-9=lost)</li>
                    <li><strong>Pre-qualification:</strong> Based on CIM analysis using Grok API + title verification</li>
                </ul>
            </div>
        </div>

        <!-- Source Data Verification -->
        <div class="bg-gray-100 rounded-lg p-6">
            <h3 class="text-lg font-bold mb-4">Data Verification & Source Access</h3>
            <p class="text-sm text-gray-700 mb-4">Click any metric above to view source data and calculations. All data is traceable to original listings.</p>
            <div class="flex flex-wrap gap-2">
                <button class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700" onclick="showModal('allListings')">
                    View All Listings
                </button>
                <button class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700" onclick="showModal('sbaListings')">
                    SBA Pre-Qualified Listings
                </button>
                <button class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700" onclick="exportData()">
                    Export Raw Data
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-4">Last updated: <span id="lastUpdated"></span></p>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Load data
        let dashboardData = {};
        let listingsData = [];
        let loiStats = {};

        // Initialize dashboard
        async function initDashboard() {
            try {
                // Load data files
                const [summaryRes, listingsRes, loiRes] = await Promise.all([
                    fetch('dashboard_summary_robust.json'),
                    fetch('dashboard_listings_full.json'),
                    fetch('dashboard_loi_stats.json')
                ]);

                dashboardData = await summaryRes.json();
                listingsData = await listingsRes.json();
                loiStats = await loiRes.json();

                // Update UI
                updateStats();
                createCharts();
                
                // Set last updated
                document.getElementById('lastUpdated').textContent = dashboardData.last_updated || new Date().toLocaleString();
            } catch (error) {
                console.error('Error loading data:', error);
                // Fallback with sample data
                loadFallbackData();
            }
        }

        function loadFallbackData() {
            // Fallback data if JSON files aren't loaded
            dashboardData = {
                sba_prequalification: {
                    total_prequalified: 102,
                    actually_used_sba: 21,
                    preq_no_sba_use: 21,
                    usage_rate: 50.0
                },
                days_on_market: {
                    actually_used_sba: { mean: 187.2, median: 151 },
                    preq_no_sba: { mean: 183.8, median: 136 },
                    not_prequalified: { mean: 166.0, median: 116 }
                }
            };
            
            loiStats = {
                total_lois: 1203,
                sba_lois: 192,
                sba_loi_percentage: 16.0
            };
            
            updateStats();
            createCharts();
        }

        function updateStats() {
            // Update LOI stats
            document.getElementById('totalLOIs').textContent = loiStats.total_lois || '-';
            document.getElementById('sbaOffers').textContent = `${loiStats.sba_lois} (${loiStats.sba_loi_percentage}%)`;
            document.getElementById('sbaOfferRate').textContent = `${loiStats.sba_loi_percentage}%`;
            document.getElementById('sbaWinRate').textContent = '61%'; // From analysis
        }

        function createCharts() {
            // Time Breakdown Chart
            const timeCtx = document.getElementById('timeBreakdownChart').getContext('2d');
            new Chart(timeCtx, {
                type: 'bar',
                data: {
                    labels: ['Actually Used SBA', 'Pre-Q, No SBA', 'Not Pre-Qualified'],
                    datasets: [{
                        label: 'Days on Market (Mean)',
                        data: [
                            dashboardData.days_on_market?.actually_used_sba?.mean || 187,
                            dashboardData.days_on_market?.preq_no_sba?.mean || 184,
                            dashboardData.days_on_market?.not_prequalified?.mean || 166
                        ],
                        backgroundColor: [
                            'rgba(249, 158, 11, 0.8)',
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(41, 125, 222, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 150,
                            title: { display: true, text: 'Days' }
                        }
                    }
                }
            });

            // Success Rate Chart
            const successCtx = document.getElementById('successRateChart').getContext('2d');
            new Chart(successCtx, {
                type: 'bar',
                data: {
                    labels: ['SBA Pre-Qualified', 'Not Pre-Qualified'],
                    datasets: [{
                        label: 'Success Rate %',
                        data: [74.5, 59.1],
                        backgroundColor: [
                            'rgba(54, 161, 87, 0.8)',
                            'rgba(156, 163, 175, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Distribution Chart (for distribution tab)
            if (document.getElementById('distributionChart')) {
                const distCtx = document.getElementById('distributionChart').getContext('2d');
                new Chart(distCtx, {
                    type: 'line',
                    data: {
                        labels: ['0', '30', '60', '90', '120', '150', '180', '210', '240', '270', '300+'],
                        datasets: [{
                            label: 'Used SBA',
                            data: [0, 5, 10, 20, 35, 50, 65, 80, 90, 95, 100],
                            borderColor: 'rgba(249, 158, 11, 1)',
                            fill: false
                        }, {
                            label: 'Not Pre-Qualified',
                            data: [0, 8, 18, 35, 50, 65, 80, 90, 95, 98, 100],
                            borderColor: 'rgba(41, 125, 222, 1)',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Cumulative Distribution of Days on Market'
                            }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: 'Cumulative %' }
                            },
                            x: {
                                title: { display: true, text: 'Days on Market' }
                            }
                        }
                    }
                });
            }
        }

        // Modal functions
        function showModal(type) {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modalContent');
            
            switch(type) {
                case 'datasetBreakdown':
                    content.innerHTML = `
                        <h2 class="text-xl font-bold mb-4">Dataset Breakdown</h2>
                        <table class="w-full data-table">
                            <tr><td>Total CIMs Analyzed</td><td class="font-bold">582</td></tr>
                            <tr><td>Valid Listings (Sold/Lost)</td><td class="font-bold">531</td></tr>
                            <tr><td>- Sold</td><td>339 (63.8%)</td></tr>
                            <tr><td>- Lost</td><td>192 (36.2%)</td></tr>
                            <tr><td>Excluded (No outcome)</td><td>51</td></tr>
                        </table>
                        <div class="mt-4 p-4 bg-blue-50 rounded">
                            <p class="text-sm"><strong>Methodology:</strong> Used milestone IDs for classification. 
                            Milestone 7 = sold, Milestones 8-9 = lost, Others = excluded.</p>
                        </div>
                    `;
                    break;
                    
                case 'sbaUsageDetails':
                    content.innerHTML = `
                        <h2 class="text-xl font-bold mb-4">SBA Usage Detailed Analysis</h2>
                        <h3 class="font-semibold mt-4">Among 76 Sold SBA Pre-Qualified Listings:</h3>
                        <table class="w-full data-table mt-2">
                            <tr><td>With LOI data available</td><td class="font-bold">42</td></tr>
                            <tr><td>Actually used SBA financing</td><td class="font-bold">21 (50%)</td></tr>
                            <tr><td>Used other financing</td><td class="font-bold">21 (50%)</td></tr>
                        </table>
                        <h3 class="font-semibold mt-4">Time Impact by Financing Choice:</h3>
                        <table class="w-full data-table mt-2">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Mean Days</th>
                                    <th>Median Days</th>
                                    <th>vs Baseline</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Used SBA</td>
                                    <td>187</td>
                                    <td>151</td>
                                    <td class="text-orange-600">+21 days</td>
                                </tr>
                                <tr>
                                    <td>Pre-Q, No SBA</td>
                                    <td>184</td>
                                    <td>136</td>
                                    <td class="text-yellow-600">+18 days</td>
                                </tr>
                                <tr>
                                    <td>Not Pre-Q (baseline)</td>
                                    <td>166</td>
                                    <td>116</td>
                                    <td>-</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    break;
                    
                case 'allListings':
                    let listingsHtml = `
                        <h2 class="text-xl font-bold mb-4">All Listings Data</h2>
                        <div class="mb-4">
                            <input type="text" id="searchListings" placeholder="Search listings..." class="border rounded px-3 py-1 w-full" onkeyup="filterListings()">
                        </div>
                        <div style="max-height: 60vh; overflow-y: auto;">
                            <table class="w-full data-table" id="listingsTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Status</th>
                                        <th>SBA Status</th>
                                        <th>Days on Market</th>
                                        <th>Used SBA</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    listingsData.slice(0, 100).forEach(listing => {
                        listingsHtml += `
                            <tr>
                                <td>${listing.id}</td>
                                <td class="text-xs">${listing.name.substring(0, 50)}...</td>
                                <td>${listing.status}</td>
                                <td>${listing.sba_status}</td>
                                <td>${listing.days_on_market || '-'}</td>
                                <td>${listing.actually_used_sba === true ? 'Yes' : listing.actually_used_sba === false ? 'No' : '-'}</td>
                            </tr>
                        `;
                    });
                    
                    listingsHtml += `
                                </tbody>
                            </table>
                        </div>
                        <p class="text-sm text-gray-500 mt-4">Showing first 100 of ${listingsData.length} listings</p>
                    `;
                    content.innerHTML = listingsHtml;
                    break;
                    
                case 'sbaListings':
                    const sbaListings = listingsData.filter(l => l.sba_status === 'yes');
                    let sbaHtml = `
                        <h2 class="text-xl font-bold mb-4">SBA Pre-Qualified Listings</h2>
                        <div style="max-height: 60vh; overflow-y: auto;">
                            <table class="w-full data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Status</th>
                                        <th>Days on Market</th>
                                        <th>Actually Used SBA</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    sbaListings.forEach(listing => {
                        sbaHtml += `
                            <tr>
                                <td>${listing.id}</td>
                                <td class="text-xs">${listing.name.substring(0, 60)}...</td>
                                <td>${listing.status}</td>
                                <td>${listing.days_on_market || '-'}</td>
                                <td>${listing.actually_used_sba === true ? '‚úì Yes' : listing.actually_used_sba === false ? '‚úó No' : '-'}</td>
                            </tr>
                        `;
                    });
                    
                    sbaHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    content.innerHTML = sbaHtml;
                    break;
                    
                default:
                    content.innerHTML = '<p>Loading...</p>';
            }
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Create distribution chart if needed
            if (tabName === 'distribution' && !document.getElementById('distributionChart').chart) {
                setTimeout(() => createDistributionChart(), 100);
            }
        }

        function filterListings() {
            const search = document.getElementById('searchListings').value.toLowerCase();
            const rows = document.querySelectorAll('#listingsTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function exportData() {
            const dataStr = JSON.stringify({
                summary: dashboardData,
                listings: listingsData,
                loi_stats: loiStats
            }, null, 2);
            
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sba_analysis_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>